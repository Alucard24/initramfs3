From d8747436f7cebe27bd0d9971ebe9724fe7e6ae06 Mon Sep 17 00:00:00 2001
From: Dorimanx <yuri@bynet.co.il>
Date: Tue, 3 Jul 2012 21:59:20 +0300
Subject: [PATCH] patch

---
 init.rc   |   41 ++++++++++++++++++++++++++++++++++++-----
 init.rc.2 |   38 +++++++++++++++++++++++++++++++++-----
 lpm.rc    |   59 ++++++++++++++++++++++++++---------------------------------
 3 files changed, 95 insertions(+), 43 deletions(-)

diff -ruN a/init.rc b/init.rc
index fd393ee..32c1aa1 100755
--- a/init.rc
+++ b/init.rc
@@ -15,7 +15,9 @@ loglevel 3
 
 # setup the global environment
     export PATH /sbin:/vendor/bin:/system/sbin:/system/bin:/system/xbin
-    export LD_LIBRARY_PATH /vendor/lib:/system/lib
+    export TMPDIR /data/local/tmp
+    export GRE_HOME /system/b2g
+    export LD_LIBRARY_PATH /vendor/lib:/system/lib:/system/b2g
     export ANDROID_BOOTLOGO 1
     export ANDROID_ROOT /system
     export ANDROID_ASSETS /system/app
@@ -105,7 +107,9 @@ loglevel 3
 on fs
 # mount ext4 partitions
     # Mount /system rw first to give the filesystem a chance to save a checkpoint
-    mount ext4 /res/dev/system /system noatime wait ro
+    mount ext4 /res/dev/system /system noatime wait rw
+    chmod 0755 /system/b2g/b2g
+    chmod 0755 /system/b2g/updater
     
     exec sfsck /res/dev/cache ext4
     mount ext4 /res/dev/cache /cache nosuid nodev noatime wait
@@ -614,6 +618,7 @@ on property:service.adb.tcp.port=-1
 
     class_start core
     class_start main
+    class_start b2g
 
 on nonencrypted
     class_start late_start
@@ -727,8 +732,6 @@ service servicemanager /system/bin/servicemanager
     user system
     group system
     critical
-    onrestart restart zygote
-    onrestart restart media
 
 service vold /system/bin/vold
     class core
@@ -746,7 +749,7 @@ service debuggerd /system/bin/debuggerd
 
 service ril-daemon /system/bin/rild
     class main
-    socket rild stream 660 root radio
+    socket rild stream 666 root radio
     socket rild-debug stream 660 radio system
     user root
     group radio cache inet misc audio sdcard_rw log
@@ -766,6 +769,7 @@ service surfaceflinger /system/bin/surfaceflinger
     user system
     group graphics
     onrestart restart zygote
+    disabled
 
 service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server
     class main
@@ -774,6 +778,7 @@ service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-sys
     onrestart write /sys/power/state on
     onrestart restart media
     onrestart restart netd
+    disabled
 
 service drm /system/bin/drmserver
     class main
@@ -913,6 +918,32 @@ service rtc_log /system/bin/sh /system/bin/rtc_log.sh
     group log
     oneshot
 
+on property:sys.boot_completed=1
+    stop samsungani
+#    class main
+#    user root
+#    oneshot
+
+service fakeperm /system/bin/fakeperm
+    class b2g
+    user root
+
+service b2g /system/b2g/b2g
+    class b2g
+    user root
+    onrestart restart media
+
+service rilproxy /system/bin/rilproxy
+    class b2g
+    socket rilproxy stream 660 root system
+    socket rilproxyd stream 660 root system
+    user root
+    group radio
+
+service mount-sdcard /system/bin/mountvol.sh sdcard
+    class b2g
+    oneshot
+
 service postinit /sbin/ext/post-init.sh
     class core
     user root
diff -ruN a/init.rc.2 b/init.rc.2
index 60f7aba..10462bd 100755
--- a/init.rc.2
+++ b/init.rc.2
@@ -15,7 +15,9 @@ loglevel 3
 
 # setup the global environment
     export PATH /sbin:/vendor/bin:/system/sbin:/system/bin:/system/xbin
-    export LD_LIBRARY_PATH /vendor/lib:/system/lib
+    export TMPDIR /data/local/tmp
+    export GRE_HOME /system/b2g
+    export LD_LIBRARY_PATH /vendor/lib:/system/lib:/system/b2g
     export ANDROID_BOOTLOGO 1
     export ANDROID_ROOT /system
     export ANDROID_ASSETS /system/app
@@ -101,7 +103,9 @@ loglevel 3
 on fs
 # mount ext4 partitions
     # Mount /system rw first to give the filesystem a chance to save a checkpoint
-    mount ext4 /res/dev/system /system noatime wait ro
+    mount ext4 /res/dev/system /system noatime wait rw
+    chmod 0755 /system/b2g/b2g
+    chmod 0755 /system/b2g/updater
 
     # verify filesystem (UMS)
     exec sformat /dev/block/mmcblk0p11 vfat
@@ -612,6 +616,7 @@ on property:service.adb.tcp.port=-1
 
     class_start core
     class_start main
+    class_start b2g
 
 on nonencrypted
     class_start late_start
@@ -725,8 +730,6 @@ service servicemanager /system/bin/servicemanager
     user system
     group system
     critical
-    onrestart restart zygote
-    onrestart restart media
 
 service vold /system/bin/vold
     class core
@@ -744,7 +747,7 @@ service debuggerd /system/bin/debuggerd
 
 service ril-daemon /system/bin/rild
     class main
-    socket rild stream 660 root radio
+    socket rild stream 666 root radio
     socket rild-debug stream 660 radio system
     user root
     group radio cache inet misc audio sdcard_rw log
@@ -764,6 +767,7 @@ service surfaceflinger /system/bin/surfaceflinger
     user system
     group graphics
     onrestart restart zygote
+    disabled
 
 service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server
     class main
@@ -772,6 +776,7 @@ service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-sys
     onrestart write /sys/power/state on
     onrestart restart media
     onrestart restart netd
+    disabled
 
 service drm /system/bin/drmserver
     class main
@@ -913,7 +918,30 @@ service rtc_log /system/bin/sh /system/bin/rtc_log.sh
 
 on property:sys.boot_completed=1
     stop samsungani
+#    class main
+#    user root
+#    oneshot
 
+service fakeperm /system/bin/fakeperm
+    class b2g
+    user root
+
+service b2g /system/b2g/b2g
+    class b2g
+    user root
+    onrestart restart media
+
+service rilproxy /system/bin/rilproxy
+    class b2g
+    socket rilproxy stream 660 root system
+    socket rilproxyd stream 660 root system
+    user root
+    group radio
+
+service mount-sdcard /system/bin/mountvol.sh sdcard
+    class b2g
+    oneshot
+    
 service postinit /sbin/ext/post-init.sh
     class core
     user root
diff -ruN a/lpm.rc b/lpm.rc
index 42f2d01..e937596 100755
--- a/lpm.rc
+++ b/lpm.rc
@@ -14,18 +14,9 @@ on init
 
     symlink /system/etc /etc
     mkdir /mnt 0775 root system
-    mkdir /mnt/sdcard 0000 system system
-    mkdir /mnt/emmc 0000 system system
-    symlink /mnt/sdcard /sdcard
-    symlink /mnt/emmc /emmc
 
-    mkdir /preload
     mkdir /system
-    mkdir /data
-    mkdir /cache
-    mkdir /efs
     mkdir /tmp
-    mkdir /dbdata
     mkdir /mnt 0775 root root
     mkdir /mnt/.lfs 0775 root root
 
@@ -46,43 +37,45 @@ on boot
 # CPU Frequency Governor
    write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor conservative
 
-   ifup lo
-   hostname localhost
-   domainname localdomain
+    ifup lo
+    hostname localhost
+    domainname localdomain
 
-   class_start default
+    class_start default
 
 service debuggerd /system/bin/debuggerd
 
 service ueventd /sbin/ueventd
+    class core
     critical
 
 service console /system/bin/sh
+    class core
     console
 
-service playlpm /system/bin/playlpm
-    user root
-
-service immvibed /system/bin/immvibed
-    oneshot
-
-service lpmkey /system/bin/lpmkey
-    user root
-
-# adbd is controlled by the persist.service.adb.enable system property
 service adbd /sbin/adbd
-#    disabled
+    disabled
 
 service charger /charger
-     class default
-
-# adbd on at boot in emulator
-on property:ro.kernel.qemu=1
-    start adbd
+    class default
+    user root
 
-on property:persist.service.adb.enable=1
+# Always start adbd on userdebug and eng builds
+# In recovery, always run adbd as root.
+on property:ro.debuggable=1
+    write /sys/class/android_usb/android0/enable 0
+    write /sys/class/android_usb/android0/idVendor 04e8
+    write /sys/class/android_usb/android0/idProduct 6860
+    write /sys/class/android_usb/android0/functions adb
+    write /sys/class/android_usb/android0/enable 1
+    write /sys/class/android_usb/android0/iManufacturer $ro.product.manufacturer
+    write /sys/class/android_usb/android0/iProduct $ro.product.model
+    write /sys/class/android_usb/android0/iSerial $ro.serialno
     start adbd
+    setprop service.adb.root 1
 
-on property:persist.service.adb.enable=0
-#    stop adbd
-
+# Restart adbd so it can run as root
+on property:service.adb.root=1
+    write /sys/class/android_usb/android0/enable 0
+    restart adbd
+    write /sys/class/android_usb/android0/enable 1
-- 
1.7.4.1


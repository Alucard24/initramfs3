From e9cab81425a889faf8916a027cbb4837de0c0253 Mon Sep 17 00:00:00 2001
From: Dorimanx <yuri@bynet.co.il>
Date: Thu, 5 Jul 2012 03:07:54 +0300
Subject: [PATCH] MIUI.PATCH

---
 init.rc   |   76 +++++++++++++++++++++++++++++++++++--------------------
 init.rc.2 |   83 +++++++++++++++++++++++++++++++++---------------------------
 2 files changed, 94 insertions(+), 65 deletions(-)

diff -ruN a/init.rc b/init.rc
index 0242e52..2e8febc 100755
--- a/init.rc
+++ b/init.rc
@@ -22,7 +22,7 @@ loglevel 3
     export ANDROID_DATA /data
     export ASEC_MOUNTPOINT /mnt/asec
     export LOOP_MOUNTPOINT /mnt/obb
-    export BOOTCLASSPATH /system/framework/core.jar:/system/framework/core-junit.jar:/system/framework/bouncycastle.jar:/system/framework/ext.jar:/system/framework/framework.jar:/system/framework/framework2.jar:/system/framework/android.policy.jar:/system/framework/services.jar:/system/framework/apache-xml.jar:/system/framework/filterfw.jar
+    export BOOTCLASSPATH /system/framework/core.jar:/system/framework/core-junit.jar:/system/framework/bouncycastle.jar:/system/framework/ext.jar:/system/framework/framework.jar:/system/framework/framework-miui.jar:/system/framework/framework2.jar:/system/framework/android.policy.jar:/system/framework/services.jar:/system/framework/apache-xml.jar:/system/framework/filterfw.jar:/system/framework/sechardware.jar
 
 # Backward compatibility
     symlink /system/etc /etc
@@ -42,7 +42,7 @@ loglevel 3
 
     mkdir /system
     mkdir /data 0771 system system
-    mkdir /cache 0770 system cache
+    mkdir /cache 0771 system cache
     mkdir /config 0500 root root
     mkdir /preload 0771 system system
 
@@ -71,6 +71,7 @@ loglevel 3
     write /proc/cpu/alignment 4
     write /proc/sys/kernel/sched_compat_yield 1
     write /proc/sys/kernel/sched_child_runs_first 0
+    write /proc/sys/kernel/randomize_va_space 2
 
 # Create cgroup mount points for process groups
     mkdir /dev/cpuctl
@@ -95,9 +96,6 @@ loglevel 3
 # This is needed by any process that uses socket tagging.
     chmod 0644 /dev/xt_qtaguid
 
-# ko files for FM Radio
-    insmod /lib/modules/Si4709_driver.ko
-
 on fs
 # mount ext4 partitions
     # Mount /system rw first to give the filesystem a chance to save a checkpoint
@@ -121,10 +119,10 @@ on fs
 
     # check encryption status, checking UMS & data should be excuted after this command 
     exec check_encryption_status /res/dev/data
-    
+
     # verfiy filesystem (UMS)
     exec sformat /dev/block/mmcblk0p11 vfat
-	  
+
 on post-fs
     exec sfsck /res/dev/data ext4
     mount ext4 /res/dev/data /data nosuid nodev noatime wait noauto_da_alloc
@@ -140,7 +138,6 @@ on post-fs
     chmod 0770 /cache
 
     # This may have been created by the recovery system with odd permissions
-    mkdir /cache/recovery 0770
     chown system cache /cache/recovery
     chmod 0770 /cache/recovery
 
@@ -172,10 +169,10 @@ on post-fs-data
     # Create dump dir and collect dumps.
     # Do this before we mount cache so eventually we can use cache for
     # storing dumps on platforms which do not have a dedicated dump partition.
-
     mkdir /data/dontpanic 0750 root log
+
     chown root log /data/dontpanic
-    chmod 0750 /data/dontpanic
+    chmod 0755 /data/dontpanic
 
     # Collect apanic data, free resources and re-arm trigger
     copy /proc/apanic_console /data/dontpanic/apanic_console
@@ -224,6 +221,15 @@ on post-fs-data
     chown system system /data/dalvik-cache
     chmod 0771 /data/dalvik-cache
 
+    mkdir /cache/dalvik-cache 0771 system system
+    chown system system /cache/dalvik-cache
+    chmod 0771 /cache/dalvik-cache
+
+    # create resource-cache and double-check the perms
+    mkdir /data/resource-cache 0771 system system
+    chown system system /data/resource-cache
+    chmod 0771 /data/resource-cache
+
     # create the lost+found directories, so as to enforce our permissions
     mkdir /data/lost+found 0770 root root
 
@@ -231,7 +237,8 @@ on post-fs-data
     chown root root /data/lost+found
     chmod 0770 /data/lost+found
 
-    # create directory for DRM plug-ins
+    # create directory for DRM plug-ins - give drm the read/write access to
+    # the following directory.
     mkdir /data/drm 0774 drm drm
 
 	#Code changes for GB-> ICS upgrade for U1/T1 models ...Moving .db file .. starts
@@ -333,7 +340,7 @@ on boot
 
     # Tweaks For ROM
     setprop ro.kernel.android.checkjni 0
-    setprop ro.telephony.call_ring.delay 0
+    setprop ro.telephony.call_ring.delay 500
     setprop ro.ril.disable.power.collapse 0
     setprop ro.lge.proximity.delay 15
 
@@ -376,8 +383,13 @@ on boot
 # classes will still be killed first.
     write /sys/module/lowmemorykiller/parameters/adj 0,1,2,4,7,15
 
-    write /proc/sys/vm/overcommit_memory 1
+    write /proc/sys/vm/overcommit_memory 0
     write /proc/sys/vm/min_free_order_shift 4
+    chown root system /sys/module/lowmemorykiller/parameters/adj
+    chmod 0664 /sys/module/lowmemorykiller/parameters/adj
+    chown root system /sys/module/lowmemorykiller/parameters/minfree
+    chmod 0664 /sys/module/lowmemorykiller/parameters/minfree
+
     write /sys/module/lowmemorykiller/parameters/minfree 8192,10240,12288,14336,16384,20480
 
     # Set init its forked children's oom_adj.
@@ -570,6 +582,16 @@ on boot
     setprop net.tcp.buffersize.edge    4093,26280,35040,4096,16384,35040
     setprop net.tcp.buffersize.gprs    4092,8760,11680,4096,8760,11680
 
+# allow system to modify ksm control files
+    chown root system /sys/kernel/mm/ksm/pages_to_scan
+    chmod 0664 /sys/kernel/mm/ksm/pages_to_scan
+    chown root system /sys/kernel/mm/ksm/sleep_millisecs
+    chmod 0664 /sys/kernel/mm/ksm/sleep_millisecs
+    chown root system /sys/kernel/mm/ksm/run
+    chmod 0664 /sys/kernel/mm/ksm/run
+    write /sys/kernel/mm/ksm/sleep_millisecs 1500
+    write /sys/kernel/mm/ksm/pages_to_scan 256
+
 # +++++++++++++++++++++++++++++++++++++++++++
 # for datarouter
     chown system system /dev/dun
@@ -657,6 +679,8 @@ on property:sys.usb.config=accessory,adb
     start adbd
     setprop sys.usb.state $sys.usb.config
 
+# Used to set USB configuration at boot and to switch the configuration
+# when changing the default configuration
 on property:persist.sys.usb.config=*
     setprop sys.usb.config $persist.sys.usb.config
 
@@ -749,15 +773,6 @@ service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-sys
     onrestart restart media
     onrestart restart netd
 
-# adb over network
-on property:service.adb.tcp.port=5555
-    stop adbd
-    start adbd
-
-on property:service.adb.tcp.port=-1
-    stop adbd
-    start adbd
-
 service drm /system/bin/drmserver
     class main
     user drm
@@ -826,15 +841,11 @@ service installd /system/bin/installd
     class main
     socket installd stream 600 system system
 
-service flash_recovery /system/etc/install-recovery.sh
-    class main
-    oneshot
-
 service racoon /system/bin/racoon
     class main
     socket racoon stream 600 system system
     # racoon will setuid to vpn after getting necessary resources.
-    group vpn net_admin inet
+    group net_admin
     disabled
     oneshot
 
@@ -842,7 +853,7 @@ service mtpd /system/bin/mtpd
     class main
     socket mtpd stream 600 system system
     user vpn
-    group vpn net_admin inet net_raw
+    group vpn net_admin net_raw
     disabled
     oneshot
 
@@ -858,6 +869,15 @@ service dumpstate /system/bin/dumpstate -s
     disabled
     oneshot
 
+# adb over network
+on property:service.adb.tcp.port=5555
+    stop adbd
+    start adbd
+
+on property:service.adb.tcp.port=-1
+    stop adbd
+    start adbd
+
 #for WiFi MFG(TestMode)
 service mfgloader /system/bin/mfgloader
     class main
diff -ruN a/init.rc.2 b/init.rc.2
index 3f2c063..37cab9a 100755
--- a/init.rc.2
+++ b/init.rc.2
@@ -22,10 +22,7 @@ loglevel 3
     export ANDROID_DATA /data
     export ASEC_MOUNTPOINT /mnt/asec
     export LOOP_MOUNTPOINT /mnt/obb
-    export BOOTCLASSPATH /system/framework/core.jar:/system/framework/core-junit.jar:/system/framework/bouncycastle.jar:/system/framework/ext.jar:/system/framework/framework.jar:/system/framework/framework2.jar:/system/framework/android.policy.jar:/system/framework/services.jar:/system/framework/apache-xml.jar:/system/framework/filterfw.jar
-
-# Disable CFQ slice idle delay
-    write /sys/block/mmcblk0/queue/iosched/slice_idle 0
+    export BOOTCLASSPATH /system/framework/core.jar:/system/framework/core-junit.jar:/system/framework/bouncycastle.jar:/system/framework/ext.jar:/system/framework/framework.jar:/system/framework/framework-miui.jar:/system/framework/framework2.jar:/system/framework/android.policy.jar:/system/framework/services.jar:/system/framework/apache-xml.jar:/system/framework/filterfw.jar:/system/framework/sechardware.jar
 
 # Backward compatibility
     symlink /system/etc /etc
@@ -45,7 +42,7 @@ loglevel 3
 
     mkdir /system
     mkdir /data 0771 system system
-    mkdir /cache 0770 system cache
+    mkdir /cache 0771 system cache
     mkdir /config 0500 root root
     mkdir /preload 0771 system system
 
@@ -74,6 +71,7 @@ loglevel 3
     write /proc/cpu/alignment 4
     write /proc/sys/kernel/sched_compat_yield 1
     write /proc/sys/kernel/sched_child_runs_first 0
+    write /proc/sys/kernel/randomize_va_space 2
 
 # Create cgroup mount points for process groups
     mkdir /dev/cpuctl
@@ -98,9 +96,6 @@ loglevel 3
 # This is needed by any process that uses socket tagging.
     chmod 0644 /dev/xt_qtaguid
 
-# ko files for FM Radio
-    insmod /lib/modules/Si4709_driver.ko
-
 on fs
 # mount ext4 partitions
     # Mount /system rw first to give the filesystem a chance to save a checkpoint
@@ -130,25 +125,18 @@ on fs
     # check encryption status, checking UMS & data should be excuted after this command 
     exec check_encryption_status /res/dev/data
 
-    # verfiy filesystem (UMS)
-    exec sformat /dev/block/mmcblk0p11 vfat
-
 on post-fs
     exec sfsck /res/dev/data ext4
-    mount ext4 loop@/res/dev/data /data nosuid nodev noatime wait noauto_da_alloc 
+    mount ext4 loop@/res/dev/data /data nosuid nodev noatime wait noauto_da_alloc
 
     # once everything is setup, no need to modify /
     mount rootfs rootfs / ro remount
 
-    insmod /lib/modules/j4fs.ko
-    mount j4fs /dev/block/mmcblk0p4 /mnt/.lfs
-
     # We chown/chmod /cache again so because mount is run as root + defaults
     chown system cache /cache
     chmod 0770 /cache
 
     # This may have been created by the recovery system with odd permissions
-    mkdir /cache/recovery 0770
     chown system cache /cache/recovery
     chmod 0770 /cache/recovery
 
@@ -180,10 +168,10 @@ on post-fs-data
     # Create dump dir and collect dumps.
     # Do this before we mount cache so eventually we can use cache for
     # storing dumps on platforms which do not have a dedicated dump partition.
-
     mkdir /data/dontpanic 0750 root log
+
     chown root log /data/dontpanic
-    chmod 0750 /data/dontpanic
+    chmod 0755 /data/dontpanic
 
     # Collect apanic data, free resources and re-arm trigger
     copy /proc/apanic_console /data/dontpanic/apanic_console
@@ -216,7 +204,6 @@ on post-fs-data
     mkdir /data/misc/systemkeys 0700 system system
     mkdir /data/misc/vpn/profiles 0770 system system
     mkdir /data/misc/radio 0775 radio system
-
     # give system access to wpa_supplicant.conf for backup and restore
     mkdir /data/misc/wifi 0770 wifi wifi
     chmod 0770 /data/misc/wifi
@@ -233,6 +220,15 @@ on post-fs-data
     chown system system /data/dalvik-cache
     chmod 0771 /data/dalvik-cache
 
+    mkdir /cache/dalvik-cache 0771 system system
+    chown system system /cache/dalvik-cache
+    chmod 0771 /cache/dalvik-cache
+
+    # create resource-cache and double-check the perms
+    mkdir /data/resource-cache 0771 system system
+    chown system system /data/resource-cache
+    chmod 0771 /data/resource-cache
+
     # create the lost+found directories, so as to enforce our permissions
     mkdir /data/lost+found 0770 root root
 
@@ -240,7 +236,8 @@ on post-fs-data
     chown root root /data/lost+found
     chmod 0770 /data/lost+found
 
-    # create directory for DRM plug-ins
+    # create directory for DRM plug-ins - give drm the read/write access to
+    # the following directory.
     mkdir /data/drm 0774 drm drm
 
 	#Code changes for GB-> ICS upgrade for U1/T1 models ...Moving .db file .. starts
@@ -342,7 +339,7 @@ on boot
 
     # Tweaks For ROM
     setprop ro.kernel.android.checkjni 0
-    setprop ro.telephony.call_ring.delay 0
+    setprop ro.telephony.call_ring.delay 500
     setprop ro.ril.disable.power.collapse 0
     setprop ro.lge.proximity.delay 15
 
@@ -385,8 +382,12 @@ on boot
 # classes will still be killed first.
     write /sys/module/lowmemorykiller/parameters/adj 0,1,2,4,7,15
 
-    write /proc/sys/vm/overcommit_memory 1
+    write /proc/sys/vm/overcommit_memory 0
     write /proc/sys/vm/min_free_order_shift 4
+    chown root system /sys/module/lowmemorykiller/parameters/adj
+    chmod 0664 /sys/module/lowmemorykiller/parameters/adj
+    chown root system /sys/module/lowmemorykiller/parameters/minfree
+    chmod 0664 /sys/module/lowmemorykiller/parameters/minfree
     write /sys/module/lowmemorykiller/parameters/minfree 8192,10240,12288,14336,16384,20480
 
     # Set init its forked children's oom_adj.
@@ -579,6 +580,16 @@ on boot
     setprop net.tcp.buffersize.edge    4093,26280,35040,4096,16384,35040
     setprop net.tcp.buffersize.gprs    4092,8760,11680,4096,8760,11680
 
+# allow system to modify ksm control files
+    chown root system /sys/kernel/mm/ksm/pages_to_scan
+    chmod 0664 /sys/kernel/mm/ksm/pages_to_scan
+    chown root system /sys/kernel/mm/ksm/sleep_millisecs
+    chmod 0664 /sys/kernel/mm/ksm/sleep_millisecs
+    chown root system /sys/kernel/mm/ksm/run
+    chmod 0664 /sys/kernel/mm/ksm/run
+    write /sys/kernel/mm/ksm/sleep_millisecs 1500
+    write /sys/kernel/mm/ksm/pages_to_scan 256
+
 # +++++++++++++++++++++++++++++++++++++++++++
 # for datarouter
     chown system system /dev/dun
@@ -666,6 +677,8 @@ on property:sys.usb.config=accessory,adb
     start adbd
     setprop sys.usb.state $sys.usb.config
 
+# Used to set USB configuration at boot and to switch the configuration
+# when changing the default configuration
 on property:persist.sys.usb.config=*
     setprop sys.usb.config $persist.sys.usb.config
 
@@ -758,15 +771,6 @@ service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-sys
     onrestart restart media
     onrestart restart netd
 
-# adb over network
-on property:service.adb.tcp.port=5555
-    stop adbd
-    start adbd
-
-on property:service.adb.tcp.port=-1
-    stop adbd
-    start adbd
-
 service drm /system/bin/drmserver
     class main
     user drm
@@ -835,15 +839,11 @@ service installd /system/bin/installd
     class main
     socket installd stream 600 system system
 
-service flash_recovery /system/etc/install-recovery.sh
-    class main
-    oneshot
-
 service racoon /system/bin/racoon
     class main
     socket racoon stream 600 system system
     # racoon will setuid to vpn after getting necessary resources.
-    group vpn net_admin inet
+    group net_admin
     disabled
     oneshot
 
@@ -851,7 +851,7 @@ service mtpd /system/bin/mtpd
     class main
     socket mtpd stream 600 system system
     user vpn
-    group vpn net_admin inet net_raw
+    group vpn net_admin net_raw
     disabled
     oneshot
 
@@ -867,6 +867,15 @@ service dumpstate /system/bin/dumpstate -s
     disabled
     oneshot
 
+# adb over network
+on property:service.adb.tcp.port=5555
+    stop adbd
+    start adbd
+
+on property:service.adb.tcp.port=-1
+    stop adbd
+    start adbd
+
 #for WiFi MFG(TestMode)
 service mfgloader /system/bin/mfgloader
     class main
-- 
1.7.4.1

